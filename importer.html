

<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <link href='http://fonts.googleapis.com/css?family=Archivo+Narrow:400,700|Oswald:400,700' rel='stylesheet' type='text/css'>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.8.2.js" type="text/javascript"></script>
</head>
<body>
    <script type="text/javascript" src="aws/scripts/blahgua_restapi.js"></script>
    <script type="text/javascript" src="aws/scripts/jquery.csv-0.71.min.js"></script>
    <script type="text/javascript">
        var ArrayData = null;
        var curRecordIndex;
        var curUserName = "";
        var curUserId = "";
        var curBlahId = "";
        var BlahTypesList = [];
        var ChannelList = null;
        var UserChannelList = [];

        var goodCount= 0;
        var badCount = 0;


        $(document).ready(function() {
            if(isAPIAvailable()) {
                $('#files').bind('change', handleFileSelect);
            }
            GetTypeNames();
        });

        function GetChannelByName(ChannelName) {
            var curChannel;
            for (curIndex in ChannelList) {
                curChannel = ChannelList[curIndex];
                if (curChannel.N == ChannelName) {
                    return curChannel._id;
                }
            }
            return null;
        }



        function UserHasGroup(ChannelName) {
            var curChannel;
            for (curIndex in UserChannelList) {
                curChannel = UserChannelList[curIndex];
                if (curChannel.N == ChannelName) {
                    return true;
                }
            }
            return false;
        }


        function AddDefaultChannelsToUser() {
            Blahgua.JoinUserToChannel(GetChannelByName("The Now Network"),
                    function () {
                        Blahgua.JoinUserToChannel(GetChannelByName("Technology"),
                                function () {
                                    Blahgua.JoinUserToChannel(GetChannelByName("Entertainment"),
                                            function() {
                                                UserChannelList = ChannelList;
                                                CreateBlahForUser();
                                            }
                                    );
                                }
                        );
                    }
            );
        }


        function GetTypeNames() {
            Blahgua.GetBlahTypes(function (json) {
                BlahTypesList = json;
            });
        }

        function GetBlahTypeStr(TypeName) {
            var curType;
            for (var curIndex in BlahTypesList) {
                curType = BlahTypesList[curIndex];
                if (curType.N == TypeName) {
                    return curType._id;
                }
            }
            return null;
        }



        // IMPORT CSV functions

        function isAPIAvailable() {
            // Check for the various File API support.
            if (window.File && window.FileReader && window.FileList && window.Blob) {
                // Great success! All the File APIs are supported.
                return true;
            } else {
                // source: File API availability - http://caniuse.com/#feat=fileapi
                // source: <output> availability - http://html5doctor.com/the-output-element/
                document.writeln('The HTML5 APIs used in this form are only available in the following browsers:<br />');
                // 6.0 File API & 13.0 <output>
                document.writeln(' - Google Chrome: 13.0 or later<br />');
                // 3.6 File API & 6.0 <output>
                document.writeln(' - Mozilla Firefox: 6.0 or later<br />');
                // 10.0 File API & 10.0 <output>
                document.writeln(' - Internet Explorer: Not supported (partial support expected in 10.0)<br />');
                // ? File API & 5.1 <output>
                document.writeln(' - Safari: Not supported<br />');
                // ? File API & 9.2 <output>
                document.writeln(' - Opera: Not supported');
                return false;
            }
        }

        function handleFileSelect(evt) {
            var files = evt.target.files; // FileList object
            var file = files[0];

            // read the file metadata
            var output = ''
            output += '<span style="font-weight:bold;">' + escape(file.name) + '</span><br />\n';
            output += ' - FileType: ' + (file.type || 'n/a') + '<br />\n';
            output += ' - FileSize: ' + file.size + ' bytes<br />\n';
            output += ' - LastModified: ' + (file.lastModifiedDate ? file.lastModifiedDate.toLocaleDateString() : 'n/a') + '<br />\n';

            // read the file contents
            printTable(file);

            // post the results
            $('#list').append(output);
        }

        function printTable(file) {
            ArrayData = [];
            var reader = new FileReader();
            reader.readAsText(file);
            reader.onload = function(event){
                var csv = event.target.result;
                var data = $.csv.toArrays(csv);
                var html = '';
                for(var row in data) {
                    ArrayData.push(data[row]);
                    html += '<tr>\r\n';
                    for(var item in data[row]) {
                        html += '<td>' + data[row][item] + '</td>\r\n';
                    }
                    html += '</tr>\r\n';
                }
                $('#contents').html(html);
            };
            reader.onerror = function(){ alert('Unable to read ' + file.fileName); };
        }


        // Do the creation

        function BlahCreateItem(curRow) {
            this.Channel = curRow[0];
            this.Username = curRow[1];
            this.BlahType = curRow[2];
            this.Title = curRow[3];
            this.Body = curRow[4];
            this.Image = curRow[5];
            this.ImagePath = curRow[6];
            this.Data1 = curRow[7];
            this.Data2 = curRow[8];
            this.Data3 = curRow[9];
            this.Data4 = curRow[10];
            this.Data5 = curRow[11];
            this.Data6 = curRow[12];
            this.Data7 = curRow[13];
            this.Data8 = curRow[14];
            this.Data9 = curRow[15];
            this.Data10 = curRow[16];
        }

        function DoImport() {
            if (ArrayData == null) {
                alert("No data loaded.");
            } else {
                curRecordIndex = 1;
                ImportNextRecord();
            }
        }

        function ImportNextRecord() {
            if(curRecordIndex < ArrayData.length) {
                CurRecord = new BlahCreateItem(ArrayData[curRecordIndex]);

                setCurrentUser(CurRecord.Username);
            } else {
                alert ("Import Complete. " + goodCount + " succeeded, " + badCount + " failed.");
            }

        }

        function setCurrentUser(userName) {
            if (userName != curUserName) {
                if (curUserName != "") {
                    Blahgua.logoutUser();
                    curUserName = "";
                    UserChannelList = [];
                }

                Blahgua.CheckUsernameExists(userName, function() {
                    // does not exist
                    Blahgua.CreateUser(userName, "secret", function() {
                        SignInUser(userName);
                    });
                }, function () {
                    // already exists
                    SignInUser(userName);
                });
            }  else {
                CreateBlahForUser();
            }
        }

        function SignInUser(userName) {
            Blahgua.loginUser(userName, "secret", function (theUser) {
                curUserName = userName;
                if(ChannelList == null ) {
                    Blahgua.GetFeaturedChannels(function (channelList) {
                        ChannelList = channelList;
                        Blahgua.GetUserChannels(function (userChannelList) {
                            UserChannelList = userChannelList;
                            CreateBlahForUser();
                        });
                    });
                } else {
                    Blahgua.GetUserChannels(function (userChannelList) {
                        UserChannelList = userChannelList;
                        CreateBlahForUser();
                    });
                }
            });
        }




        function CreateBlahForUser() {
            if (UserHasGroup(CurRecord.Channel)) {
                CreateTheBlah();
            }  else {
                Blahgua.JoinUserToChannel(GetChannelByName(CurRecord.Channel), function() {
                    CreateTheBlah();
                });
            }
        }

        function CreateTheBlah() {
            var blahText = CurRecord.Title;
            var blahGroup = GetChannelByName(CurRecord.Channel);
            var bodyText = CurRecord.Body;
            var blahType = GetBlahTypeStr(CurRecord.BlahType);
            var infoObj = null;
            if (CurRecord.BlahType == "polls") {
                var curPollItemCount = 1;
                var pollItems = [];
                var curPollString= "Data" + curPollItemCount;
                var curPollText = CurRecord[curPollString];
                var curPollItem;

                while((curPollItemCount < 10) && (curPollText !="") && (curPollText)) {
                    curPollItem = new Object();
                    curPollItem["G"] = curPollText;
                    curPollItem["T"] = "";
                    pollItems.push(curPollItem);
                    curPollItemCount++;
                    curPollString= "Data" + curPollItemCount;
                    curPollText = CurRecord[curPollString];
                }
                infoObj = new Object();
                infoObj["I"] = pollItems;
            } else if (CurRecord.BlahType == "predicts") {
                infoObj = new Object();
                var theDateStr = CurRecord.Data1;
                var theDate = new Date(theDateStr);
                infoObj["E"] = theDate;
            }

            Blahgua.CreateUserBlah(blahText, blahType, blahGroup, bodyText, infoObj, function(theBlah) {
                // now do the image
                /*
                if (CurRecord.Image != "") {
                    var imagePath = CurRecord.ImagePath + "\\" + CurRecord.Image;
                    $("#objectId").val(theBlah._id);
                    $("#BlahImage").val(imagePath);
                    UploadBlahImage(theBlah._id);
                } else {
                    FinishRowAndContinue(true);
                }
                */
                FinishRowAndContinue(true);
            }, function (theErr) {
                FinishRowAndContinue(false);
            })
        }

    function FinishRowAndContinue(didIt) {
        if (didIt)  {
            $("tr")[curRecordIndex].style.backgroundColor ="green";
            goodCount++;
        }
        else {
            badCount++;
            $("tr")[curRecordIndex].style.backgroundColor ="red";
        }
        // now do the next blah
        curRecordIndex++;
        ImportNextRecord();
    }



        function UploadBlahImage(blahId) {
            $("#objectId").val(blahId);
            var formData = new FormData($("#ImageForm")[0]);
            $.ajax({
                url: "http://beta.blahgua.com/v2/images/upload",

                type: 'POST',
                xhr: function() { // custom xhr
                    myXhr = $.ajaxSettings.xhr();
                    return myXhr;
                },
                //Ajax events
                success: completeHandler = function(data) {
                    FinishRowAndContinue(true);

                },
                error: errorHandler = function(theErr) {
                    FinishRowAndContinue(false);
                },
                // Form data
                data: formData,
                //Options to tell JQuery not to process data or worry about content-type
                cache: false,
                contentType: false,
                processData: false
            }, 'json');
        }


    </script>

<h2>Blahgua CSV Importer</h2>
<p>Welcome!  Please choose a CSV file:</p>
    <div id=inputs class=clearfix>
        <input type=file id=files name=files[] multiple />
        <button onclick="DoImport(); return false;">Import to Blahgua</button>
    </div>
    <hr />
    <output id=list>
    </output>
    <hr />
    <table id=contents style="width:100%; height:400px;" border>
    </table>






    <form id="ImageForm" action="http://beta.blahgua.com/v2/images/upload" method="post" enctype="multipart/form-data">
        <div style="display:none">
            <input id="BlahImage" name="file" type="file"  hidden="true" >

            <input type="text" name="objectType" hidden="true" value="B"/>
            <input type="text" id="objectId" name="objectId" hidden="true" value=""/>
            <input type="text" name="primary" hidden="true" value="true"/>
        </div>
    </form>
</body>
</html>
